name: CI/CD Pipeline for hoangsonww

concurrency:
  group: ci-cd-pipeline-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  spellcheck:
    name: "üß™ Spellcheck README"
    runs-on: ubuntu-latest
    outputs:
      spellcheck_issues: ${{ steps.spell.outputs.spellcheck_issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
        continue-on-error: true

      - id: spell
        name: Run cspell on README
        run: |
          echo "Spellchecking README.md..."
          npx cspell "README.md" || rc=$? && echo "cspell reported issues (swallowed);" 
          # capture whether there were issues
          if npx cspell "README.md" >/dev/null 2>&1; then
            echo "spellcheck_issues=false" >> $GITHUB_OUTPUT
          else
            echo "spellcheck_issues=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  markdownlint:
    name: "üìê Markdown Lint README"
    runs-on: ubuntu-latest
    outputs:
      markdownlint_issues: ${{ steps.lint.outputs.markdownlint_issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
        continue-on-error: true

      - id: lint
        name: Run markdownlint on README
        run: |
          echo "Linting README.md..."
          npx markdownlint-cli "README.md" || echo "markdownlint reported issues (swallowed);"
          if npx markdownlint-cli "README.md" >/dev/null 2>&1; then
            echo "markdownlint_issues=false" >> $GITHUB_OUTPUT
          else
            echo "markdownlint_issues=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  prettier-check:
    name: "üé® Prettier Check README"
    runs-on: ubuntu-latest
    outputs:
      prettier_issues: ${{ steps.check.outputs.prettier_issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
        continue-on-error: true

      - id: check
        name: Check formatting with Prettier
        run: |
          echo "Checking README.md formatting..."
          npx prettier --check "README.md" || echo "Prettier check found diffs or failed (swallowed);"
          if npx prettier --check "README.md" >/dev/null 2>&1; then
            echo "prettier_issues=false" >> $GITHUB_OUTPUT
          else
            echo "prettier_issues=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  link-check:
    name: "üîó Link Validation README"
    runs-on: ubuntu-latest
    outputs:
      linkcheck_issues: ${{ steps.link.outputs.linkcheck_issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
        continue-on-error: true

      - id: link
        name: Validate links in README
        run: |
          echo "Checking links in README.md..."
          npx markdown-link-check "README.md" -q || echo "Link check reported problems (swallowed);"
          if npx markdown-link-check "README.md" -q >/dev/null 2>&1; then
            echo "linkcheck_issues=false" >> $GITHUB_OUTPUT
          else
            echo "linkcheck_issues=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  summary:
    name: "üìä Aggregate Summary"
    runs-on: ubuntu-latest
    needs: [spellcheck, markdownlint, prettier-check, link-check]
    if: always()
    steps:
      - name: Summary of README checks
        run: |
          echo "===== README Quality Summary ====="
          echo "Spellcheck issues:         ${{ needs.spellcheck.outputs.spellcheck_issues }}"
          echo "Markdownlint issues:       ${{ needs.markdownlint.outputs.markdownlint_issues }}"
          echo "Prettier formatting issues: ${{ needs['prettier-check'].outputs.prettier_issues }}"
          echo "Link check issues:         ${{ needs.link-check.outputs.linkcheck_issues }}"
          echo "=================================="
          any_issue=false
          if [ "${{ needs.spellcheck.outputs.spellcheck_issues }}" = "true" ] || \
             [ "${{ needs.markdownlint.outputs.markdownlint_issues }}" = "true" ] || \
             [ "${{ needs['prettier-check'].outputs.prettier_issues }}" = "true" ] || \
             [ "${{ needs.link-check.outputs.linkcheck_issues }}" = "true" ]; then
            any_issue=true
          fi
          if [ "$any_issue" = "true" ]; then
            echo "‚ö†Ô∏è One or more checks reported issues (all swallowed)."
          else
            echo "‚úÖ All checks passed with no reported issues."
          fi

  complete:
    name: "üéâ Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [summary]
    if: always()
    steps:
      - name: Final status
        run: echo "‚úÖ README quality pipeline finished (no errors surfaced)."
